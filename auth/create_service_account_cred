set -euxo pipefail

GOOGLE_APPLICATION_CREDENTIALS=~/.config/gcloud/terraform-admin.json

gcloud auth login

project_id="$(gcloud projects list  --format="csv[no-heading](PROJECT_ID)")"

key_id="$(gcloud iam service-accounts keys list --iam-account terraform@"${project_id}".iam.gserviceaccount.com --format="csv[no-heading](KEY_ID)" --filter="CREATED_AT>=2018-07-27T00:00:00Z" | head -1)"
gcloud iam service-accounts keys delete "${key_id}" --iam-account terraform@"${project_id}".iam.gserviceaccount.com -q

gcloud iam service-accounts keys create "${GOOGLE_APPLICATION_CREDENTIALS}" --iam-account terraform@"${project_id}".iam.gserviceaccount.com

gcloud auth activate-service-account --key-file="${GOOGLE_APPLICATION_CREDENTIALS}"

cluster="$(gcloud container clusters list --format="csv[no-heading](NAME)")"
zone="$(gcloud container clusters list --format="csv[no-heading](LOCATION)")"

gcloud container clusters get-credentials "${cluster}" --zone "${zone}" --project "${project_id}"